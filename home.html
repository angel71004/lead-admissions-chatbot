
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LEAD College Admission Chatbot — MCA / MBA</title>
  <style>
    :root{
      --bg:#f3f6fb; --panel:#ffffff; --accent:#2b6cb0; --muted:#6b7280;
      --user:#dcf8c6; --staff:#eef2ff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{ margin:0; min-height:100vh; background:linear-gradient(180deg,#eef7ff 0%,var(--bg) 100%); display:flex; align-items:center; justify-content:center; padding:24px;}
    /* INCREASED CONTAINER WIDTH FROM 960px TO 1200px */
    .container{ width:1200px; max-width:100%; background:var(--panel); box-shadow:0 8px 30px rgba(19,38,84,0.08); border-radius:12px; overflow:hidden; display:grid; grid-template-columns:380px 1fr;}
    .left{ background:linear-gradient(180deg,#2b6cb0,#3676c6); color:#fff; padding:24px; display:flex; flex-direction:column; gap:16px;}
    .brand{ font-size:18px; font-weight:700; display:flex; gap:12px; align-items:center;}
    .brand .logo{ width:44px; height:44px; background:rgba(255,255,255,0.15); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .info{ font-size:14px; color:rgba(255,255,255,0.92); line-height:1.45;}
    .tips{ margin-top:auto; font-size:13px; opacity:0.95; background:rgba(255,255,255,0.06); padding:10px; border-radius:8px;}
    .right{ padding:20px; display:flex; flex-direction:column; gap:12px;}
    /* INCREASED CHAT WINDOW HEIGHT FROM 520px TO 600px */
    .chat-window{ background:linear-gradient(180deg,#fbfdff,#ffffff); border:1px solid #eef2f7; border-radius:10px; padding:18px; height:520px; overflow:auto; display:flex; flex-direction:column; gap:12px;}
    .messages{ display:flex; flex-direction:column; gap:10px; }
    .msg{ max-width:78%; padding:10px 12px; border-radius:12px; font-size:14px; line-height:1.35; box-shadow:0 1px 0 rgba(0,0,0,0.02);}
    .staff{ align-self:flex-start; background:var(--staff); color:#06304a; border-radius:10px 12px 12px 12px; }
    .user{ align-self:flex-end; background:var(--user); color:#1b4332; border-radius:12px 12px 10px 12px; text-align:right;}
    .controls{ display:flex; gap:10px; align-items:center; margin-top:8px;}
    .input{ flex:1; display:flex; gap:8px;}
    input[type="text"], select, textarea{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6eef8; outline:none; font-size:14px; background:#fff; transition:border-color 0.2s ease;}
    input.invalid{ border-color:#e53e3e !important; box-shadow:0 0 0 2px rgba(229,62,62,0.1);}
    button.primary{ background:var(--accent); border:none; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600;}
    button.ghost{ background:transparent; border:1px solid #dbe9ff; color:var(--accent); padding:8px 12px; border-radius:8px; cursor:pointer;}
    .summary{ white-space:pre-wrap; font-family:monospace; background:#f7fafc; padding:12px; border-radius:8px; border:1px dashed #e6eef8; font-size:13px;}
    .small{ font-size:13px; color:#6b7280; }
    footer{ font-size:12px; color:#6b7280; text-align:center; padding:10px 0;}
    @media (max-width:900px){ .container{ grid-template-columns:1fr; } .left{ display:none; } .chat-window{ height:66vh; } }
  </style>
</head>
<body>
  <div class="container" role="main">
    <aside class="left" aria-hidden="false">
      <div class="brand">
        <div class="logo">LEAD</div>
        <div>
          <div style="font-size:16px">LEAD College (Autonomous), Palakkad </div>
          <div style="font-size:12px; opacity:0.9">Admissions Assistant</div>
        </div>
      </div>
      <div class="info">
        Hello! I'm <strong>Clara</strong>, your admissions assistant. I can:
        <ul style="margin:8px 0 0 18px;">
          <li>Collect your details for MCA / MBA admissions</li>
          <li>Verify eligibility based on academic qualifications</li>
          <li>Guide you through entrance exam requirements</li>
          <li>Automatically save and download your application</li>
        </ul>
      </div>
      <div class="tips">
        Tip: Your application data will be automatically downloaded as a CSV file upon completion.
      </div>
    </aside>
    <section class="right" aria-live="polite">
      <div class="chat-window" id="chatWindow" role="region" aria-label="Admission chat">
        <div class="messages" id="messages"></div>
      </div>
      <div class="controls">
        <div class="input" style="flex-direction:column;">
          <input id="userInput" type="text" placeholder="Type your message here..." aria-label="Type your message" />
          <div style="display:flex; gap:8px; margin-top:8px;">
            <select id="quickSelect" aria-label="Quick replies">
              <option value="">— quick replies —</option>
              <option>Apply for MCA</option>
              <option>Apply for MBA</option>
              <option>Tell me eligibility</option>
              <option>Fee structure</option>
              <option>Entrance exams</option>
              <option>Application process</option>
              <option>I need hostel</option>
              <option>No hostel</option>
            </select>
            <button class="ghost" id="btnRestart">Restart</button>
            <button class="primary" id="btnSend">Send</button>
          </div>
        </div>
      </div>
      <div id="summaryBox" style="display:none;">
        <button id="downloadCSV" class="primary" style="margin-bottom:12px; width:220px;">Download All Applications CSV</button>
        <div class="small">Collected application summary (client-side only):</div>
        <div class="summary" id="appSummary"></div>
      </div>
      <footer>This is a template demo — integrate into Django templates/view (no DB).</footer>
    </section>
  </div>
  <script>
    (function(){
      const messagesEl = document.getElementById('messages');
      const chatWindow = document.getElementById('chatWindow');
      const input = document.getElementById('userInput');
      const sendBtn = document.getElementById('btnSend');
      const restartBtn = document.getElementById('btnRestart');
      const quickSelect = document.getElementById('quickSelect');
      const summaryBox = document.getElementById('summaryBox');
      const appSummary = document.getElementById('appSummary');
      const downloadCSVBtn = document.getElementById('downloadCSV');

      let inFollowUpLoop=false;

      // Application data object matching first code structure
      const app = {
        name: '', course:'', email:'', phone:'', dob:'',
        degree_name:'', degree_specialization:'', degree_college:'', degree_year: '', degree_marks:'',
        math_background: '', is_final_year: '',
        plus_two_stream:'', plus_two_subjects:'', plus_two_marks:'',
        entrance_exam: '', entrance_score: '',
        city:'', hostel:''
      };

      // The chatbot flow/questions - EXACTLY FROM FIRST CODE
      const flow = [
        {key:'name', text:"Hello! I am Clara, your Admissions AI. I require your full name to start processing your profile.", validate: s=>/^[A-Za-z.\-'\s]{2,100}$/.test(s.trim()), error: "Error: Please enter a valid full name (letters only)."},
        {key:'course', text:"Acknowledged. Specify your target program: MCA or MBA?", validate: s=>/(MCA|MBA)/i.test(s), error: "Error: Input must be 'MCA' or 'MBA'."},
        {key:'email', text:"Confirmation received. Input your email address for official communication.", validate: s=>/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/.test(s.trim()), error: "Error: Invalid email format detected (e.g., user@example.com)."},
        {key:'phone', text:"Input your 10-digit contact number. Essential for immediate verification.", validate: s=>/^\d{10}$/.test(s.trim()), error: "Error: Phone number must be exactly 10 digits."},
        {key:'dob', text:"What is your Date of Birth? (Use format: DD-MM-YYYY)", validate: s=>/^\d{2}-\d{2}-\d{4}$/.test(s.trim()), error: "Error: Please use the format DD-MM-YYYY."},
        {key:'degree_name', text:"UG Degree type: BCA, B.Com, B.Sc, BBA, B.Tech, etc.?"},
        {key:'degree_specialization', text:"What was your UG specialization? (e.g., Computer Science, Finance, Mechanical)"},
        {key:'degree_college', text:"Name the college/university where you completed your UG degree."},
        {key:'degree_year', text:"What year did you complete your UG degree? (YYYY) Or type 'Final Year' if you are currently studying.", validate: s=>(/^\d{4}$/.test(s.trim()) || /final year/i.test(s)), error: "Error: Please enter the 4-digit year or 'Final Year'."},
        {key:'is_final_year', text:"Are you a Final Year Student? Please confirm with 'Yes' or 'No'.", validate: s=>/^(yes|no)/i.test(s.trim()), error: "Error: Please respond with 'Yes' or 'No'."},
        {key:'degree_marks', text:"State your overall percentage or CGPA in your degree (e.g., 78.5 or 8.36).", validate: s=>(/^\d{1,3}(\.\d+)?$/.test(s.trim()) && parseFloat(s)>=0 && parseFloat(s)<=100), error: "Error: Input must be a numeric mark or CGPA."},
        {key:'math_background', text:"Did you study Mathematics at the 10+2 level or during your UG degree? (Yes / No)", validate: s=>/^(yes|no)/i.test(s.trim()), error: "Error: Please respond with 'Yes' or 'No'."},
        {key:'plus_two_stream', text:"Shifting to Plus Two data. What was your stream (Science / Commerce / Arts)?"},
        {key:'plus_two_subjects', text:"List your main subjects in Plus Two (e.g., Physics, Chemistry, Maths)."},
        {key:'plus_two_marks', text:"Input your aggregate percentage or grade in Plus Two (e.g., 86.2).", validate: s=>(/^\d{1,3}(\.\d+)?$/.test(s.trim()) && parseFloat(s)>=0 && parseFloat(s)<=100), error: "Error: Input must be a numeric mark or CGPA."},
        {key:'entrance_exam', text:"Have you appeared in any Entrance Exam (CAT, MAT, CMAT, NIMCET, etc.)? If so, state the exam name. If not, type 'None'."},
        {key:'entrance_score', text:"Please provide your Entrance Exam Score or 'NA' if you entered 'None' previously."},
        {key:'city', text:"Location data required: Which city or town are you currently based in?"},
        {key:'hostel', text:"Final query: Will you require hostel accommodation? (Yes / No)", validate: s=>/^(yes|no)/i.test(s.trim()), error: "Error: Please respond with 'Yes' or 'No'."},
      ];
      let step=0;

      function appendStaff(text){ const d=document.createElement('div'); d.className='msg staff'; d.innerText=text; messagesEl.appendChild(d); chatWindow.scrollTop=chatWindow.scrollHeight;}
      function appendUser(text){ const d=document.createElement('div'); d.className='msg user'; d.innerText=text; messagesEl.appendChild(d); chatWindow.scrollTop=chatWindow.scrollHeight;}

      function markInvalid(){ input.classList.add('invalid'); setTimeout(()=>input.classList.remove('invalid'),1200); }

      function startConversation(){
        messagesEl.innerHTML='';
        step=0;
        inFollowUpLoop=false;
        summaryBox.style.display='none';
        Object.keys(app).forEach(k=>app[k]='');
        askCurrent();
      }

      function askCurrent(){
        if(step<flow.length){
          appendStaff(flow[step].text);
          input.placeholder="Type your message here...";
          input.focus();
        } else {
          showSummary();
          saveStudentData(app);
          // AUTO-DOWNLOAD CSV after a short delay
          setTimeout(() => {
            autoDownloadCurrentApplication();
          }, 1000);
        }
      }

      function showSummary(){
        const s=`═══════════════════════════════════════
LEAD COLLEGE ADMISSION APPLICATION DATA
═══════════════════════════════════════

Name: ${app.name}
Course: ${app.course}
Email: ${app.email}
Phone: ${app.phone}
Date of Birth: ${app.dob}
City: ${app.city}
Hostel Required: ${app.hostel}

UG Degree: ${app.degree_name} (${app.degree_specialization})
College: ${app.degree_college} / Year: ${app.degree_year} / Final Year: ${app.is_final_year}
UG Marks: ${app.degree_marks}
Math Background: ${app.math_background}

Plus Two Stream: ${app.plus_two_stream} / Subjects: ${app.plus_two_subjects}
Plus Two Marks: ${app.plus_two_marks}

Entrance Exam: ${app.entrance_exam} / Score: ${app.entrance_score}

═══════════════════════════════════════`;
        appendStaff("Application data collection complete. Profile generation commencing...");
        appendStaff(s);
        appendStaff("✅ Your application is being automatically downloaded as a CSV file...");
        summaryBox.style.display='block';
        appSummary.innerText=s;
      }

      // Save student data to localStorage
      function saveStudentData(studentObj) {
        let allData = JSON.parse(localStorage.getItem('lead_applications') || '[]');
        allData.push({...studentObj});
        localStorage.setItem('lead_applications', JSON.stringify(allData));
      }

      // AUTO-DOWNLOAD the current application immediately
      function autoDownloadCurrentApplication() {
        // Define the exact column order matching the app object
        const headers = [
          'name', 'course', 'email', 'phone', 'dob',
          'degree_name', 'degree_specialization', 'degree_college', 'degree_year',
          'is_final_year', 'degree_marks', 'math_background',
          'plus_two_stream', 'plus_two_subjects', 'plus_two_marks',
          'entrance_exam', 'entrance_score', 'city', 'hostel'
        ];

        // Create human-readable headers
        const headerLabels = [
          'Name', 'Course', 'Email', 'Phone', 'Date of Birth',
          'UG Degree', 'UG Specialization', 'UG College', 'UG Year',
          'Final Year Student', 'UG Marks/CGPA', 'Math Background',
          'Plus Two Stream', 'Plus Two Subjects', 'Plus Two Marks',
          'Entrance Exam', 'Entrance Score', 'City', 'Hostel Required'
        ];

        const csvRows = [];
        csvRows.push(headerLabels.join(','));

        // Add the current application data
        const values = headers.map(h => `"${(app[h]||'').toString().replace(/"/g,'""')}"`);
        csvRows.push(values.join(','));

        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;

        // Create filename with timestamp and student name
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const studentName = app.name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        a.download = `LEAD_Application_${studentName}_${timestamp}.csv`;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Manual download of ALL applications (kept as backup option)
      function downloadAllApplicationsCSV() {
        let allData = JSON.parse(localStorage.getItem('lead_applications') || '[]');
        if (allData.length === 0) {
          alert("No applications to export.");
          return;
        }

        // Define the exact column order matching the app object
        const headers = [
          'name', 'course', 'email', 'phone', 'dob',
          'degree_name', 'degree_specialization', 'degree_college', 'degree_year',
          'is_final_year', 'degree_marks', 'math_background',
          'plus_two_stream', 'plus_two_subjects', 'plus_two_marks',
          'entrance_exam', 'entrance_score', 'city', 'hostel'
        ];

        // Create human-readable headers
        const headerLabels = [
          'Name', 'Course', 'Email', 'Phone', 'Date of Birth',
          'UG Degree', 'UG Specialization', 'UG College', 'UG Year',
          'Final Year Student', 'UG Marks/CGPA', 'Math Background',
          'Plus Two Stream', 'Plus Two Subjects', 'Plus Two Marks',
          'Entrance Exam', 'Entrance Score', 'City', 'Hostel Required'
        ];

        const csvRows = [];
        csvRows.push(headerLabels.join(','));

        // Add data rows for all applications
        for (const row of allData) {
          const values = headers.map(h => `"${(row[h]||'').toString().replace(/"/g,'""')}"`);
          csvRows.push(values.join(','));
        }

        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `LEAD_All_Applications_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      document.addEventListener('DOMContentLoaded', function() {
        if (downloadCSVBtn) downloadCSVBtn.onclick = downloadAllApplicationsCSV;
      });

      sendBtn.onclick=()=>{
        const t=input.value.trim();
        if (!t) return;
        handleAnswer(t);
        input.value='';
      };

      input.addEventListener('keydown',e=>{
        if(e.key==='Enter'){
          e.preventDefault();
          sendBtn.click();
        }
      });

      quickSelect.onchange=()=>{
        const v=quickSelect.value;
        if(v){
          input.value=v;
          sendBtn.click();
          quickSelect.value='';
        }
      };

      restartBtn.onclick=startConversation;
      startConversation();

      function handleAnswer(text){
        const q=flow[step], val=text.trim();
        if(!val){
          appendStaff("Please type your answer.");
          markInvalid();
          return;
        }

        // Validate if validation exists
        if(q.validate && !q.validate(val)){
          appendStaff(q.error);
          markInvalid();
          return;
        }

        // Store the value
        if(q.key === 'course'){
          app[q.key] = /MCA/i.test(val) ? 'MCA' : 'MBA';
        } else {
          app[q.key] = val;
        }

        appendUser(text);
        step++;
        setTimeout(askCurrent,450);
      }
    })();
  </script>
</body>
</html>